<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å› æœå›¾è°±å¯è§†åŒ– - Causal Graph Viewer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        input[type="text"] {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .main-content {
            display: flex;
            height: calc(100vh - 250px);
        }

        #graph-container {
            flex: 1;
            position: relative;
            background: #fafbfc;
        }

        #info-panel {
            width: 350px;
            background: white;
            border-left: 1px solid #dee2e6;
            padding: 20px;
            overflow-y: auto;
        }

        #info-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .info-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-section h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .info-section p {
            color: #6c757d;
            line-height: 1.6;
            font-size: 0.9em;
        }

        .node-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  å› æœå›¾è°±å¯è§†åŒ–ç³»ç»Ÿ</h1>
            <p>Patent-DeepScientist Causal Ontology Viewer</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>ç”¨æˆ·æŸ¥è¯¢:</label>
                <input type="text" id="user-query" placeholder="è¾“å…¥æŠ€æœ¯ä¸»é¢˜..." value="äººå·¥æ™ºèƒ½">
            </div>
            <button onclick="resetGraph()">ğŸ”„ é‡ç½®è§†å›¾</button>
            <button onclick="exportGraph()">ğŸ’¾ å¯¼å‡ºå›¾ç‰‡</button>
            <button onclick="togglePhysics()">âš¡ åˆ‡æ¢ç‰©ç†å¼•æ“</button>
        </div>

        <div class="main-content">
            <div id="graph-container">
                <svg id="graph"></svg>
                <div class="legend">
                    <h4>èŠ‚ç‚¹ç±»å‹</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff6b6b;"></div>
                        <span>Input (è¾“å…¥)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4ecdc4;"></div>
                        <span>Mediator (ä¸­ä»‹)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #95e1d3;"></div>
                        <span>Moderator (è°ƒèŠ‚)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f38181;"></div>
                        <span>Outcome (ç»“æœ)</span>
                    </div>
                </div>
            </div>

            <div id="info-panel">
                <h3>ğŸ“Š å›¾è°±ä¿¡æ¯</h3>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="node-count">0</div>
                        <div class="stat-label">èŠ‚ç‚¹æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="edge-count">0</div>
                        <div class="stat-label">å…³ç³»æ•°</div>
                    </div>
                </div>
                <div id="node-info">
                    <p style="color: #6c757d; text-align: center; margin-top: 30px;">
                        ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let graphData = null;
        let simulation = null;
        let physicsEnabled = true;

        // åŠ è½½æ•°æ® - æ”¯æŒå¤šç§è·¯å¾„
        const possiblePaths = [
            'static/data/causal_graph.json',
            './static/data/causal_graph.json',
            '../static/data/causal_graph.json'
        ];

        async function loadData() {
            for (const path of possiblePaths) {
                try {
                    const response = await fetch(path);
                    if (response.ok) {
                        graphData = await response.json();
                        console.log('æ•°æ®åŠ è½½æˆåŠŸ:', path);
                        initGraph();
                        return;
                    }
                } catch (error) {
                    console.log(`å°è¯•è·¯å¾„ ${path} å¤±è´¥:`, error.message);
                }
            }
            
            // å¦‚æœæ‰€æœ‰è·¯å¾„éƒ½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å†…åµŒæ•°æ®
            console.warn('æ— æ³•ä»æ–‡ä»¶åŠ è½½æ•°æ®ï¼Œä½¿ç”¨å†…åµŒæ•°æ®');
            useEmbeddedData();
        }

        function useEmbeddedData() {
            // å†…åµŒæ•°æ®ä½œä¸ºåå¤‡æ–¹æ¡ˆ
            graphData = {
                "meta": {
                    "name": "Patent-DeepScientist Causal Ontology",
                    "version": "FINAL_2.0",
                    "description": "ç§‘ç ”å‡è®¾ç”Ÿæˆå¼•æ“çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ (The Left Brain)"
                },
                "nodes": [
                    {"id": "ROOT_INTENSITY", "label": "æ ¸å¿ƒæŠ€æœ¯å¼ºåº¦", "type": "Input", "desc": "ç”¨æˆ·æŸ¥è¯¢æŠ€æœ¯ä¸»é¢˜çš„ä¸“åˆ©äº§å‡ºè§„æ¨¡", "binding": {"func": "calc_tech_intensity", "args": ["{user_query}"]}},
                    {"id": "MED_DIVERSITY", "label": "æŠ€æœ¯è·¨ç•Œåº¦", "type": "Mediator", "desc": "è¯¥æŠ€æœ¯èåˆä¸åŒIPCé¢†åŸŸçš„ä¸°å¯Œç¨‹åº¦(ç†µå€¼)", "binding": {"func": "calc_ipc_entropy", "args": ["{user_query}"]}},
                    {"id": "MED_SCIENCE", "label": "ç§‘å­¦å…³è”åº¦", "type": "Mediator", "desc": "è¯¥æŠ€æœ¯å¼•ç”¨åŸºç¡€ç§‘å­¦æ–‡çŒ®(NPL)çš„æ¯”ä¾‹", "binding": {"func": "calc_science_linkage", "args": ["{user_query}"]}},
                    {"id": "MED_SPEED", "label": "æŠ€æœ¯è¿­ä»£é€Ÿåº¦", "type": "Mediator", "desc": "æŠ€æœ¯æ›´æ–°æ¢ä»£çš„å‘¨æœŸ(TCT)", "binding": {"func": "calc_cycle_time", "args": ["{user_query}"]}},
                    {"id": "MED_EFFICIENCY", "label": "ç ”å‘æ•ˆç‡", "type": "Mediator", "desc": "å•ä½ç ”å‘æŠ•å…¥äº§å‡ºçš„ä¸“åˆ©æ•°é‡", "binding": {"func": "calc_rd_efficiency", "args": ["{user_query}"]}},
                    {"id": "OUT_IMPACT", "label": "æŠ€æœ¯å½±å“åŠ›", "type": "Outcome", "desc": "ä¸“åˆ©è¢«å¼•ç”¨çš„æ€»æ¬¡æ•°(Forward Citations)", "binding": {"func": "calc_citation_impact", "args": ["{user_query}"]}},
                    {"id": "OUT_INDEPENDENCE", "label": "æŠ€æœ¯ç‹¬ç«‹æ€§", "type": "Outcome", "desc": "æŠ€æœ¯è‡ªä¸»å¯æ§ç¨‹åº¦(å¼•ç”¨æœ¬å›½ä¸“åˆ©å æ¯”)", "binding": {"func": "calc_tech_independence", "args": ["{user_query}"]}},
                    {"id": "OUT_PROFIT", "label": "ä¼ä¸šç»©æ•ˆ", "type": "Outcome", "desc": "ä¸“åˆ©å¹³å‡ç»´æŒå¹´é™(ä½œä¸ºå•†ä¸šä»·å€¼ä»£ç†å˜é‡)", "binding": {"func": "calc_firm_performance", "args": ["{user_query}"]}},
                    {"id": "MOD_COLLAB", "label": "äº§å­¦ç ”åˆä½œ", "type": "Moderator", "desc": "ç”³è¯·äººä¸­æ˜¯å¦åŒ…å«é«˜æ ¡/ç ”ç©¶æ‰€", "binding": {"func": "calc_collaboration_ratio", "args": ["{user_query}"]}}
                ],
                "edges": [
                    {"source": "ROOT_INTENSITY", "target": "MED_EFFICIENCY", "relation": "æ­£å‘ä¿ƒè¿›", "template": "éšç€{user_query}é¢†åŸŸæŠ•å…¥è§„æ¨¡çš„å¢åŠ ï¼Œç ”å‘ä½“ç³»çš„æˆç†Ÿå¾€å¾€ä¼šæ˜¾è‘—æå‡**ç ”å‘æ•ˆç‡**ã€‚"},
                    {"source": "MED_DIVERSITY", "target": "OUT_IMPACT", "relation": "æ­£å‘ä¿ƒè¿›", "template": "æ•°æ®è¡¨æ˜ï¼Œ**æŠ€æœ¯è·¨ç•Œåº¦**è¶Šé«˜çš„{user_query}ä¸“åˆ©ï¼Œè¶Šå®¹æ˜“äº§ç”Ÿé¢ è¦†æ€§åˆ›æ–°ï¼Œä»è€Œè·å¾—æ›´é«˜çš„**æŠ€æœ¯å½±å“åŠ›**ã€‚"},
                    {"source": "MED_SCIENCE", "target": "OUT_IMPACT", "relation": "æ­£å‘ä¿ƒè¿›", "template": "åŸºäºç§‘å­¦å¼•æ–‡çš„åˆ†ææ˜¾ç¤ºï¼Œ**ç§‘å­¦å…³è”åº¦**æ˜¯å†³å®š{user_query}æŠ€æœ¯é•¿æœŸ**å½±å“åŠ›**çš„å…³é”®å› ç´ ã€‚"},
                    {"source": "ROOT_INTENSITY", "target": "OUT_INDEPENDENCE", "relation": "å€’Uå‹è°ƒèŠ‚", "template": "å¯¹äº{user_query}æŠ€æœ¯ï¼Œå•çº¯å †ç Œæ•°é‡ä¸ä¸€å®šå¸¦æ¥**æŠ€æœ¯ç‹¬ç«‹æ€§**ï¼Œéœ€å…³æ³¨æ ¸å¿ƒä¸“åˆ©çš„è‡ªä¸»åŒ–ç‡ã€‚"},
                    {"source": "MED_EFFICIENCY", "target": "OUT_PROFIT", "relation": "æ˜¾è‘—æ­£å‘", "template": "**ç ”å‘æ•ˆç‡**çš„æå‡é€šè¿‡é™ä½è¯•é”™æˆæœ¬ï¼Œç›´æ¥è½¬åŒ–ä¸ºä¼ä¸šçš„**è´¢åŠ¡ç»©æ•ˆ**ã€‚"},
                    {"source": "MED_SPEED", "target": "OUT_PROFIT", "relation": "æ­£å‘(æ—¶æ»æ•ˆåº”)", "template": "è¾ƒå¿«çš„**æŠ€æœ¯è¿­ä»£é€Ÿåº¦**èƒ½å¸®åŠ©ä¼ä¸šæŠ¢å å¸‚åœºå…ˆæœºï¼Œä»è€Œåœ¨ä¸­é•¿æœŸæå‡**ä¼ä¸šç»©æ•ˆ**ã€‚"},
                    {"source": "MOD_COLLAB", "target": "MED_SCIENCE", "relation": "å¼ºç›¸å…³", "template": "**äº§å­¦ç ”åˆä½œ**æ¨¡å¼æ˜¾è‘—æå‡äº†{user_query}æŠ€æœ¯çš„**ç§‘å­¦å…³è”åº¦**ã€‚"}
                ]
            };
            initGraph();
        }

        loadData();

        function initGraph() {
            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('node-count').textContent = graphData.nodes.length;
            document.getElementById('edge-count').textContent = graphData.edges.length;

            // æ¸…ç©ºç°æœ‰SVG
            d3.select('#graph').selectAll('*').remove();

            const svg = d3.select('#graph')
                .attr('width', width)
                .attr('height', height);

            // æ·»åŠ ç¼©æ”¾åŠŸèƒ½
            const g = svg.append('g');
            
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });
            
            svg.call(zoom);

            // å®šä¹‰ç®­å¤´æ ‡è®°
            svg.append('defs').selectAll('marker')
                .data(['end'])
                .enter().append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 25)
                .attr('refY', 0)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', '#999');

            // èŠ‚ç‚¹é¢œè‰²æ˜ å°„
            const colorMap = {
                'Input': '#ff6b6b',
                'Mediator': '#4ecdc4',
                'Moderator': '#95e1d3',
                'Outcome': '#f38181'
            };

            // åˆ›å»ºåŠ›å¯¼å‘å›¾
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.edges)
                    .id(d => d.id)
                    .distance(150))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(50));

            // ç»˜åˆ¶è¿çº¿
            const link = g.append('g')
                .selectAll('line')
                .data(graphData.edges)
                .enter().append('line')
                .attr('stroke', '#999')
                .attr('stroke-width', 2)
                .attr('marker-end', 'url(#arrowhead)');

            // ç»˜åˆ¶è¿çº¿æ ‡ç­¾
            const linkLabel = g.append('g')
                .selectAll('text')
                .data(graphData.edges)
                .enter().append('text')
                .attr('font-size', '10px')
                .attr('fill', '#666')
                .text(d => d.relation);

            // ç»˜åˆ¶èŠ‚ç‚¹
            const node = g.append('g')
                .selectAll('g')
                .data(graphData.nodes)
                .enter().append('g')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            node.append('circle')
                .attr('r', 20)
                .attr('fill', d => colorMap[d.type] || '#ccc')
                .attr('stroke', '#fff')
                .attr('stroke-width', 3)
                .style('cursor', 'pointer')
                .on('click', (event, d) => showNodeInfo(d))
                .on('mouseover', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('r', 25);
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('r', 20);
                });

            node.append('text')
                .attr('dy', 35)
                .attr('text-anchor', 'middle')
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .attr('fill', '#333')
                .text(d => d.label);

            // æ›´æ–°ä½ç½®
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                linkLabel
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            function dragstarted(event, d) {
                if (!event.active && physicsEnabled) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active && physicsEnabled) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        function showNodeInfo(node) {
            const userQuery = document.getElementById('user-query').value || 'äººå·¥æ™ºèƒ½';
            
            // æŸ¥æ‰¾ç›¸å…³çš„è¾¹
            const incomingEdges = graphData.edges.filter(e => e.target === node.id || e.target.id === node.id);
            const outgoingEdges = graphData.edges.filter(e => e.source === node.id || e.source.id === node.id);
            
            const colorMap = {
                'Input': '#ff6b6b',
                'Mediator': '#4ecdc4',
                'Moderator': '#95e1d3',
                'Outcome': '#f38181'
            };

            let html = `
                <div class="info-section">
                    <span class="node-badge" style="background: ${colorMap[node.type]}; color: white;">
                        ${node.type}
                    </span>
                    <h4>${node.label}</h4>
                    <p><strong>ID:</strong> ${node.id}</p>
                    <p><strong>æè¿°:</strong> ${node.desc}</p>
                </div>
            `;

            if (node.binding) {
                html += `
                    <div class="info-section">
                        <h4>ğŸ”§ æ•°æ®ç»‘å®š</h4>
                        <p><strong>å‡½æ•°:</strong> ${node.binding.func}</p>
                        <p><strong>å‚æ•°:</strong> ${node.binding.args.join(', ')}</p>
                    </div>
                `;
            }

            if (outgoingEdges.length > 0) {
                html += `<div class="info-section"><h4>ğŸ“¤ è¾“å‡ºå…³ç³»</h4>`;
                outgoingEdges.forEach(edge => {
                    const targetNode = graphData.nodes.find(n => n.id === edge.target || n.id === edge.target.id);
                    const template = edge.template.replace('{user_query}', userQuery);
                    html += `<p><strong>â†’ ${targetNode.label}</strong><br/>${edge.relation}<br/><em>${template}</em></p>`;
                });
                html += `</div>`;
            }

            if (incomingEdges.length > 0) {
                html += `<div class="info-section"><h4>ğŸ“¥ è¾“å…¥å…³ç³»</h4>`;
                incomingEdges.forEach(edge => {
                    const sourceNode = graphData.nodes.find(n => n.id === edge.source || n.id === edge.source.id);
                    const template = edge.template.replace('{user_query}', userQuery);
                    html += `<p><strong>${sourceNode.label} â†’</strong><br/>${edge.relation}<br/><em>${template}</em></p>`;
                });
                html += `</div>`;
            }

            document.getElementById('node-info').innerHTML = html;
        }

        function resetGraph() {
            if (simulation) {
                simulation.alpha(1).restart();
            }
        }

        function togglePhysics() {
            physicsEnabled = !physicsEnabled;
            if (physicsEnabled) {
                simulation.alpha(1).restart();
            } else {
                simulation.stop();
            }
        }

        function exportGraph() {
            const svg = document.getElementById('graph');
            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(svg);
            const blob = new Blob([svgString], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'causal_graph.svg';
            a.click();
        }

        // å“åº”å¼è°ƒæ•´
        window.addEventListener('resize', () => {
            if (graphData) initGraph();
        });
    </script>
</body>
</html>
